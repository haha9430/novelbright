name: Deploy to k8s

on:
  push:
    branches: [ main ]

# [Ï∂îÍ∞Ä] ÎèôÏãúÏÑ± Ï†úÏñ¥ (Ïù¥Ï†Ñ ÎåÄÌôîÏóêÏÑú Í∂åÏû•ÎìúÎ¶∞ ÏÑ§Ï†ï)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # [ÏµúÏ†ÅÌôî] ÏµúÏã† Ïª§Î∞ãÎßå Í∞ÄÏ†∏Ïò§Í∏∞

      # üëá [ÌïÑÏàò Ï∂îÍ∞Ä] Ïù¥ Îã®Í≥ÑÍ∞Ä ÏóÜÏúºÎ©¥ Ï∫êÏãú export ÏóêÎü¨Í∞Ä ÎÇ©ÎãàÎã§!
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lower case owner name
        run: |
          echo "OWNER_LC=${OWNER,,}" >> ${GITHUB_ENV}
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Generate Version Tag
        id: meta
        run: |
          VERSION=$(grep '^version' pyproject.toml | head -1 | cut -d '"' -f 2)
          SHA=$(git rev-parse --short HEAD)
          TAG="${VERSION}-${SHA}"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      # [Backend ÎπåÎìú]
      - name: Build and push Docker image (Backend)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/moneta-backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/moneta-backend:latest
          # [ÏàòÏ†ï] Ï∫êÏãú ÏÑ§Ï†ï + scope Ï∂îÍ∞Ä (backendÏö©)
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      # [Frontend ÎπåÎìú]
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:latest
          # [Ï∂îÍ∞Ä] ÌîÑÎ°†Ìä∏ÏóîÎìúÎèÑ Ï∫êÏãú Ï†ÅÏö© + scope Î∂ÑÎ¶¨ (frontendÏö©)
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/workspace/deploy/novelbright
            
            git reset --hard
            git pull origin main
            
            cd infra/k8s/application
            
            BACKEND_IMAGE="ghcr.io/${{ env.OWNER_LC }}/moneta-backend:${{ env.IMAGE_TAG }}"
            FRONTEND_IMAGE="ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:${{ env.IMAGE_TAG }}"
            
            echo "Updating deployment to backend image: $BACKEND_IMAGE"
            echo "Updating deployment to frontend image: $FRONTEND_IMAGE"
            
            sed -i "s|image: ghcr.io/${{ env.OWNER_LC }}/moneta-backend:.*|image: $BACKEND_IMAGE|g" 04-backend.yaml
            sed -i "s|image: ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:.*|image: $FRONTEND_IMAGE|g" 06-frontend.yaml
            
            kubectl apply -f .
            
            kubectl rollout status deployment/backend -n moneta
            kubectl rollout status deployment/frontend -n moneta