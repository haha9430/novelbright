name: Deploy to k8s

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # [수정] GHCR은 대문자를 허용하지 않으므로 소문자로 변환하여 환경변수에 저장
      - name: Set lower case owner name
        run: |
          echo "OWNER_LC=${OWNER,,}" >> ${GITHUB_ENV}
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Generate Version Tag
        id: meta
        run: |
          VERSION=$(grep '^version' pyproject.toml | head -1 | cut -d '"' -f 2)
          SHA=$(git rev-parse --short HEAD)
          TAG="${VERSION}-${SHA}"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # [수정] 이미지 이름을 moneta-backend로 통일하고 소문자 owner 사용
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/moneta-backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/moneta-backend:latest

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend # 프론트엔드 전용 Dockerfile 지정
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:latest

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/workspace/deploy/novelbright
            
            # 최신 매니페스트 파일 가져오기
            git reset --hard
            git pull origin main
            
            cd infra/k8s/application
            
            # [수정] 배포할 이미지 주소 설정s
            BACKEND_IMAGE="ghcr.io/${{ env.OWNER_LC }}/moneta-backend:${{ env.IMAGE_TAG }}"
            FRONTEND_IMAGE="ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:${{ env.IMAGE_TAG }}"
            
            echo "Updating deployment to backend image: $BACKEND_IMAGE"
            echo "Updating deployment to frontend image: $FRONTEND_IMAGE"
            
            sed -i "s|image: ghcr.io/${{ env.OWNER_LC }}/moneta-backend:.*|image: $BACKEND_IMAGE|g" 04-backend.yaml
            sed -i "s|image: ghcr.io/${{ env.OWNER_LC }}/moneta-frontend:.*|image: $FRONTEND_IMAGE|g" 06-frontend.yaml
            
            kubectl apply -f .
            
            # 롤아웃 상태 확인 (성공할 때까지 대기)
            kubectl rollout status deployment/backend -n moneta
            kubectl rollout status deployment/frontend -n moneta